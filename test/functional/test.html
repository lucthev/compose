<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Compose Tests</title>
  <style>
    hr {
      height: 0;
      width: 260px;
      margin: 22px auto;
      padding: 0;
      border: none;
      visibility: hidden;
    }

    hr:before {
      content: '';
      width: 260px;
      height: 1px;
      background: #AAA;
      display: block;
      visibility: visible;
      margin: 22px auto;
    }

    #editor {
      margin: 40px 0 120px;
      width: 100%;
      height: 100%;
      outline: none;
      font-family: Georgia;
      font-size: 20px;
    }

    #editor section {
      width: 720px;
      margin: 0 auto;
    }

    #editor section:first-child hr {
      display: none;
    }

    pre, code {
      font-family: Consolas, monospace;
    }
  </style>
</head>
<body>
  <div id="editor">
    <section>
      <hr>
      <p><br></p>
    </section>
  </div>

  <script src="../../dist/compose.js"></script>
  <script>
    function setup (html) {
      var elem = document.querySelector('#editor')

      if (html) {
        elem.innerHTML = html
      }

      window.editor = new Compose(elem)
      var View = editor.require('view')

      View.getElements({ withSections: true }).forEach(function (el) {
        var section
        var p

        if (el.nodeName === 'SECTION') {
          section = View.handlerForElement(el).serialize(el)
          section.start = View.elements.length
          View.sections.push(section)
        } else {
          View.elements.push(el)
          p = View.handlerForElement(el).serialize(el)
          View.paragraphs.push(el.nodeName === 'LI' ? p[0] : p)
        }
      })

      var events = editor.require('events')
      var enter = editor.require('enter')
      var rm = editor.require('backspace')
      var spacebar = editor.require('spacebar')
      var Selection = editor.require('selection')
      editor.on('keydown', function onKeydown (e) {
        if (events.selectall(e)) {
          e.preventDefault()

          var len = View.paragraphs.length - 1
          var paragraph = View.paragraphs[len]

          if (/\n$/.test(paragraph.text)) {
            View.selection = new Selection([0, 0], [len, paragraph.length - 1])
          } else {
            View.selection = new Selection([0, 0], [len, paragraph.length])
          }
        } else if (events.enterKey(e)) {
          e.preventDefault()

          if (e.shiftKey) {
            enter.newline()
          } else {
            enter.newParagraph()
          }
        } else if (events.backspace(e)) {
          e.preventDefault()
          rm.backspace()

        } else if (events.forwardDelete(e)) {
          e.preventDefault()
          rm.forwardDelete()
        }
      })

      editor.on('keypress', function onKeypress (e) {
        if (events.spacebar(e)) {
          e.preventDefault()
          spacebar.auto()
        }
      })
    }

    window.addEventListener('keydown', function (e) {
      if (e.keyCode !== 9 || window.editor instanceof Compose) {
        return
      }

      e.preventDefault()
      setup()

      var View = editor.require('view')
      var Selection = editor.require('selection')

      View.selection = new Selection([0, 0])
    })
  </script>
</body>
</html>
